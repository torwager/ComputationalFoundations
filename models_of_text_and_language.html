

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Models of text and language &#8212; Computational Foundations for Neuroscience</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'models_of_text_and_language';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Recurrent Neural networks" href="recurrentneuralnets.html" />
    <link rel="prev" title="An introduction to natural language processing in Python" href="MANNING_NLP_Tutorial_CompFoundations_2023.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/yellow_flower_logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/yellow_flower_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Computational foundations for Neuroscience
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preliminary background</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="startingresources.html">Some resources</a></li>

<li class="toctree-l1"><a class="reference internal" href="topicmenu.html">A menu of topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="basicdistancecovcorr.html">Fundamentals of distance, covariance, and correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="statsinmatlab.html">Stats in Matlab</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">General linear model (GLM)</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="glm1.html">General Linear Model (GLM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="glm2_param_inference.html">Parametric inference in the GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="glm3_ashardataset.html">Sample dataset and analysis 1: Ashar 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="glm4_parameterizingglm.html">Parameterizing models in a GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="glm5_weightedleastsquares.html">Generalized Least Squares (GLS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="glm6_matlab_glm_answerkey.html">A hand-coded GLM in MATLAB</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mixed effects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="mixedfx1_intro.html">Mixed effects: Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixedfx2_examples.html">Mixed effects: Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixedfx3_algebra.html">Mixed effects algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="mixedfx4_fpr_power_sims.html">Mixed effects simulations</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Multivariate statistics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="svd.html">Singular Value Decomposition</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Bayesian models</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="activeinference_smith.html">Active inference</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reinforcement Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="reinforcementlearning.html">Reinforcement Learning</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Natural Language Processing (NLP)</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="MANNING_NLP_Tutorial_CompFoundations_2023.html">An introduction to natural language processing in Python</a></li>
























<li class="toctree-l1 current active"><a class="current reference internal" href="#">Models of text and language</a></li>







</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Neural networks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="recurrentneuralnets.html">Recurrent Neural networks</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/torwager/ComputationalFoundations" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/torwager/ComputationalFoundations/edit/master/docs/models_of_text_and_language.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/torwager/ComputationalFoundations/issues/new?title=Issue%20on%20page%20%2Fmodels_of_text_and_language.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/models_of_text_and_language.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Models of text and language</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Models of text and language</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-and-overview">Background and overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#natural-language-processing-of-movie-conversations">Natural Language Processing of movie conversations?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#meet-your-friendly-personalized-robo-ta">Meet your friendly personalized Robo-TA 🤖!</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#text-embedding-models">Text embedding models</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#text-embedding-example-1-latent-dirichlet-allocation">Text embedding example 1: Latent Dirichlet Allocation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#text-embedding-example-2-deep-embeddings">Text embedding example 2: deep embeddings</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#within-document-dynamics">Within-document “dynamics”</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#suggested-follow-ups-questions-and-exercises">Suggested follow-ups questions and exercises</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-agents">Interactive agents</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chatbot-demo-1-interactive-tutor">Chatbot demo 1: interactive “tutor”</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#chatbot-demo-2-run-a-chatbot-locally">Chatbot demo 2: run a chatbot locally!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-setup">Optional setup</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#followup-things-to-explore-try">Followup things to explore/try</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><a href="https://colab.research.google.com/github/jeremymanning/ComputationalFoundations/blob/main/CompFound/models_of_text_and_language.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="models-of-text-and-language">
<h1>Models of text and language<a class="headerlink" href="#models-of-text-and-language" title="Permalink to this heading">#</a></h1>
<p>Author: Jeremy R. Manning</p>
<p>PSYC 178: Computational Foundations for Neuroscience</p>
<p>Dartmouth College</p>
<section id="background-and-overview">
<h2>Background and overview<a class="headerlink" href="#background-and-overview" title="Permalink to this heading">#</a></h2>
<p>Natural language processing (NLP) is a branch of the field of <a class="reference external" href="https://en.wikipedia.org/wiki/Computational_linguistics">computational linguistics</a>.  The fundamental goal of NLP is to use computational approaches to process, analyze, and understand language.</p>
<p>In this tutorial, we’ll experiment with two aspects of NLP:</p>
<ul class="simple">
<li><p>Text embedding</p></li>
<li><p>Interactive agents (chatbots)</p></li>
</ul>
<section id="natural-language-processing-of-movie-conversations">
<h3>Natural Language Processing of movie conversations?<a class="headerlink" href="#natural-language-processing-of-movie-conversations" title="Permalink to this heading">#</a></h3>
<p>The approaches covered below can be applied to virtually any text dataset– stories, video or conversation transcripts, instruction manuals…you name it!  You can feel free to swap out your own preferred dataset and try out the approaches below.</p>
<p>As an illustrative example, today we’ll apply NLP to a <a class="reference external" href="https://convokit.cornell.edu/documentation/movie.html">movie dialogue dataset</a> from the <a class="reference external" href="https://convokit.cornell.edu/">Cornell Conversational Analaysis Toolkit (ConvKit)</a>.  ConvKit provides a set of nice tools for working with conversation data, along with some neat datasets.</p>
<img src='https://media0.giphy.com/media/26h0pkvcgnFIpvU1a/giphy.gif'>
<p>There’s no particularly compelling reason for choosing this dataset over the thousands of other text corporate that are “out there” in the world.  But this one seemed passingly interesting, so here we are!</p>
<p>If you’re looking for other text datasets, here are some good places to start:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/CornellNLP/ConvoKit#datasets">ConvKit datasets</a>: lots of neat conversation-related datasets</p></li>
<li><p><a class="reference external" href="https://huggingface.co/datasets">Hugging Face datasets</a>: tens of thousands of datasets of practically every shape, size, and theme.  Quality is variable across datasets, but there are <em>many</em> excellent datasets here.</p></li>
<li><p><a class="reference external" href="https://github.com/niderhoff/nlp-datasets">NLP Datasets</a>: lots of interesting datasets.  A sampling: Amazon reviews, ArXiv, Enron emails, several social media datasets, several news datasets, and more!</p></li>
<li><p><a class="reference external" href="https://data.fivethirtyeight.com/">FiveThirtyEight Data</a>: the data behind (most) FiveThirtyEight articles</p></li>
<li><p><a class="reference external" href="https://open.nytimes.com/data/home">NYT Open</a>: lots of interesting datasets behind an assortment of New York Times articles</p></li>
</ul>
</section>
</section>
<section id="meet-your-friendly-personalized-robo-ta">
<h2>Meet your friendly personalized Robo-TA 🤖!<a class="headerlink" href="#meet-your-friendly-personalized-robo-ta" title="Permalink to this heading">#</a></h2>
<p>Before we get started, check it out: this notebook has been augmented by incorporating an (experimental!) NLP tool, called <a class="reference external" href="https://github.com/ContextLab/chatify">Chatify</a> for providing interactive assistance.  Chatify uses a <a class="reference external" href="https://en.wikipedia.org/wiki/Large_language_model">large language model</a> to (attempt to) help you understand or explore any code cell in this notebook. <strong>Disclaimer: Chatify may provide incorrect, misleading, and/or otherwise harmful responses.</strong></p>
<p>If you want to use Chatify, add the <code class="docutils literal notranslate"><span class="pre">%%explain</span></code> magic command to the start of any code cell, and then run the cell (shift + enter). You can then select different options from the dropdown menus, depending on what sort of assistance you want. To disable Chatify and run the code as usual, simply delete the <code class="docutils literal notranslate"><span class="pre">%%explain</span></code> command and re-run the cell.  (If you <em>don’t</em> want to use chatify, simply don’t call the <code class="docutils literal notranslate"><span class="pre">%%explain</span></code> magic command.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install [Davos](https://github.com/ContextLab/davos) for dependency management and code safety</span>
<span class="o">%</span><span class="k">pip</span> install -qqq davos
<span class="kn">import</span> <span class="nn">davos</span>
<span class="n">davos</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">suppress_stdout</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/davos/core/project.py:896: UserWarning: Failed to identify notebook path. Falling back to generic default project
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install and enable Chatify</span>
<span class="n">smuggle</span> <span class="n">chatify</span>      <span class="c1"># pip: chatify</span>
<span class="o">%</span><span class="k">load_ext</span> chatify

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chatify has been installed and loaded! 🤖&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/importlib/metadata/__init__.py:563,</span> in <span class="ni">Distribution.from_name</span><span class="nt">(cls, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">562</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">563</span>     <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">564</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>

<span class="ne">StopIteration</span>: 

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">PackageNotFoundError</span><span class="g g-Whitespace">                      </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># @title Install and enable Chatify</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">smuggle</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;chatify&quot;</span><span class="p">,</span> <span class="n">as_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">installer</span><span class="o">=</span><span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="n">args_str</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;chatify&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">installer_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;editable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="s1">&#39;chatify&#39;</span><span class="p">})</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">&#39;load_ext&#39;</span><span class="p">,</span> <span class="s1">&#39;chatify&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chatify has been installed and loaded! 🤖&#39;</span><span class="p">)</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/davos/core/core.py:979,</span> in <span class="ni">use_project.&lt;locals&gt;.smuggle_wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">977</span> <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">978</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">979</span>     <span class="k">return</span> <span class="n">smuggle_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">980</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">981</span>     <span class="c1"># after (possibly installing and) loading the package,</span>
<span class="g g-Whitespace">    </span><span class="mi">982</span>     <span class="c1"># remove the project&#39;s site-packages directory from</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">986</span>     <span class="c1"># other dirs being prepended to load modules installed</span>
<span class="g g-Whitespace">    </span><span class="mi">987</span>     <span class="c1"># in custom locations</span>
<span class="g g-Whitespace">    </span><span class="mi">988</span>     <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">site_packages_dir</span><span class="p">))</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/davos/core/core.py:1091,</span> in <span class="ni">smuggle</span><span class="nt">(name, as_, installer, args_str, installer_kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1087</span>     <span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;pkg_resources&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">   </span><span class="mi">1088</span> <span class="c1"># check whether the smuggled package and/or any</span>
<span class="g g-Whitespace">   </span><span class="mi">1089</span> <span class="c1"># installed/updated dependencies were already imported during</span>
<span class="g g-Whitespace">   </span><span class="mi">1090</span> <span class="c1"># the current runtime</span>
<span class="ne">-&gt; </span><span class="mi">1091</span> <span class="n">prev_imported_pkgs</span> <span class="o">=</span> <span class="n">get_previously_imported_pkgs</span><span class="p">(</span><span class="n">installer_stdout</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1092</span>                                                   <span class="n">onion</span><span class="o">.</span><span class="n">installer</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1093</span> <span class="c1"># if the smuggled package was previously imported, deal with</span>
<span class="g g-Whitespace">   </span><span class="mi">1094</span> <span class="c1"># it last so it&#39;s reloaded after its dependencies are in place</span>
<span class="g g-Whitespace">   </span><span class="mi">1095</span> <span class="k">try</span><span class="p">:</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/davos/core/core.py:257,</span> in <span class="ni">get_previously_imported_pkgs</span><span class="nt">(install_cmd_stdout, installer)</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span> <span class="n">pkg_name</span> <span class="o">=</span> <span class="n">dist_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">256</span> <span class="c1"># use the install name to get the package distribution object</span>
<span class="ne">--&gt; </span><span class="mi">257</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">distribution</span><span class="p">(</span><span class="n">pkg_name</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">258</span> <span class="c1"># check the distribution&#39;s metadata for a file containing</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span> <span class="c1"># top-level import names. Also includes names of namespace</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span> <span class="c1"># packages (e.g. mpl_toolkits from matplotlib), if any.</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span> <span class="n">toplevel_names</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="s1">&#39;top_level.txt&#39;</span><span class="p">)</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/importlib/metadata/__init__.py:981,</span> in <span class="ni">distribution</span><span class="nt">(distribution_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">975</span> <span class="k">def</span> <span class="nf">distribution</span><span class="p">(</span><span class="n">distribution_name</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">976</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Get the ``Distribution`` instance for the named package.</span>
<span class="g g-Whitespace">    </span><span class="mi">977</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">978</span><span class="sd">     :param distribution_name: The name of the distribution package as a string.</span>
<span class="g g-Whitespace">    </span><span class="mi">979</span><span class="sd">     :return: A ``Distribution`` instance (or subclass thereof).</span>
<span class="g g-Whitespace">    </span><span class="mi">980</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">981</span>     <span class="k">return</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">distribution_name</span><span class="p">)</span>

<span class="nn">File /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/importlib/metadata/__init__.py:565,</span> in <span class="ni">Distribution.from_name</span><span class="nt">(cls, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">563</span>     <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">564</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">565</span>     <span class="k">raise</span> <span class="n">PackageNotFoundError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="ne">PackageNotFoundError</span>: No package metadata was found for chatify
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="text-embedding-models">
<h1>Text embedding models<a class="headerlink" href="#text-embedding-models" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Word_embedding">Text embedding models</a> are concerned with deriving mathematical representations of the “meaning” of language.  Meanings are represented as <a class="reference external" href="https://en.wikipedia.org/wiki/Feature_(machine_learning)">feature vectors</a> whose elements reflect (typically abstract) semantic properties.  The idea is that texts that convey similar meanings should have feature vectors that are “similar” (e.g., nearby in Euclidean distance, correlated, etc.).</p>
<p>One of the earliest text embedding models was <a class="reference external" href="https://en.wikipedia.org/wiki/Latent_semantic_analysis">Latent Semantic Analysis (LSA)</a>.  LSA is driven by a “word counts matrix” whose rows denote documents in a large corupus, and whose columns denote unique terms (e.g., the unique set of stemmed and lematized words in the corpus, excluding <a class="reference external" href="https://en.wikipedia.org/wiki/Stop_word">stop words</a>.).  The entries in the word counts matrix denote the number of times a given word (column) appears in a given document (row).  Applying <a class="reference external" href="https://en.wikipedia.org/wiki/Matrix_decomposition">matrix factorization</a> to the word counts matrix yields a <em>documents matrix</em> (whose rows are documents and whose columsn are “concepts”) and a <em>words matrix</em> (whose rows are concepts and whose columns are words).  In this way, we can think of each “concept” as being describable by a weighted blend of the meanings of the unique words in the model’s vocabulary.  The rows of the documents matrix may be used as “embeddings” of the documents (where similar documents are represented by similar embedding vectors) and the columns of the words matrix may be used as “embeddings” of the words (where similar words are represented by similar embeddings).</p>
<p>Topic models like <a class="reference external" href="https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation">Latent Dirichlet Allocation (LDA)</a> extended some of the fundamental ideas of LSA into a <a class="reference external" href="https://en.wikipedia.org/wiki/Generative_model">generative model</a>.  According to LDA, each “topic” (analogous to a “concept” in LSA) is a weighted blend of words in the model’s vocabulary.  Also analogous to LSA, LDA posits that each “document” reflects a weighted blend of topics.  The main difference between LSA and LDA is that LDA provides a mechanism that allows each word to potentially take on several meanings dependings on how it is used in a given document.  For example, the word “bat” might reflect an animal, a piece of sporting equipment, something done with eyelashes, and so on.</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Word2vec">Word2vec</a> further extended the notion of word embeddings using one of the earliest <a class="reference external" href="https://en.wikipedia.org/wiki/Deep_learning">deep learning</a> approaches to text embedding.  Like LSA and LDA, word2vec considers each word (from each document) independently, without regard for context or grammar (i.e., it is a so-called “<a class="reference external" href="https://en.wikipedia.org/wiki/Bag-of-words_model">bag-of-words</a>” model).</p>
<p>Most modern text embedding models incorporate some notion of word order effects, grammar, context, or other temporally varying signals. In addition to advances in the network archetectures of text embedding models, improvements in computing technology have enabled models to consider increasingly longer-duration and more complicated influences on meaning.  Whereas earlier context-sensitive models operated at scales of <a class="reference external" href="https://en.wikipedia.org/wiki/Sentence_embedding">individual sentences</a>, the most <a class="reference external" href="https://en.wikipedia.org/wiki/Large_language_model">recent models</a> operate over scales on the order to many thousands of words (e.g., entire documents and sometimes even sequences of documents).  Today’s best-performing text embedding models nearly all incorporate a network module called a <a class="reference external" href="https://en.wikipedia.org/wiki/Transformer_(machine_learning_model)">transformer</a>.  Transforms provide a means of generating representations of inputted text that reflect which words are present along with positional information.  Early transfomer-based models were used primarily for “sequence-to-sequence” tasks like <a class="reference external" href="https://en.wikipedia.org/wiki/Machine_translation">machine translation</a>, but their use has since grown to dominate the field of NLP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set up and install dependencies</span>

<span class="c1"># data wrangling and scraping</span>
<span class="n">smuggle</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">smuggle</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="n">smuggle</span> <span class="n">datawrangler</span> <span class="k">as</span> <span class="n">dw</span>  <span class="c1"># pip: pydata-wrangler[hf]</span>
<span class="n">smuggle</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span> <span class="k">as</span> <span class="n">signal</span>
<span class="n">smuggle</span> <span class="n">os</span>
<span class="n">smuggle</span> <span class="n">pickle</span>
<span class="n">smuggle</span> <span class="n">warnings</span>
<span class="kn">from</span> <span class="nn">convokit</span> <span class="n">smuggle</span> <span class="n">Corpus</span><span class="p">,</span> <span class="n">download</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="n">smuggle</span> <span class="n">chain</span>

<span class="c1"># NLP stuff</span>
<span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="n">smuggle</span> <span class="n">LlamaCpp</span>
<span class="kn">from</span> <span class="nn">langchain</span> <span class="n">smuggle</span> <span class="n">PromptTemplate</span><span class="p">,</span> <span class="n">LLMChain</span>
<span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="n">smuggle</span> <span class="n">SystemMessagePromptTemplate</span><span class="p">,</span> <span class="n">HumanMessagePromptTemplate</span><span class="p">,</span> <span class="n">ChatPromptTemplate</span>
<span class="n">smuggle</span> <span class="n">transformers</span>
<span class="n">smuggle</span> <span class="n">llama_cpp</span>           <span class="c1"># pip: llama-cpp-python</span>
<span class="kn">from</span> <span class="nn">huggingface_hub</span> <span class="n">smuggle</span> <span class="n">hf_hub_download</span>
<span class="n">smuggle</span> <span class="n">openai</span>

<span class="c1"># general-purpose machine learning and stats libraries</span>
<span class="n">smuggle</span> <span class="n">sklearn</span> <span class="k">as</span> <span class="n">skl</span>
<span class="n">smuggle</span> <span class="n">scipy</span> <span class="k">as</span> <span class="n">sp</span>
<span class="n">smuggle</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span> <span class="k">as</span> <span class="n">signal</span>

<span class="c1"># data visualization</span>
<span class="n">smuggle</span> <span class="n">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="n">smuggle</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="n">smuggle</span> <span class="n">hypertools</span> <span class="k">as</span> <span class="n">hyp</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Markdown</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;External dependencies have been loaded and configured.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>External dependencies have been loaded and configured.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Download the Movie-Dialogs corpus</span>

<span class="n">corpus</span> <span class="o">=</span> <span class="n">Corpus</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;movie-corpus&#39;</span><span class="p">))</span>
<span class="n">corpus</span><span class="o">.</span><span class="n">print_summary_stats</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading movie-corpus to /root/.convokit/downloads/movie-corpus
Downloading movie-corpus from http://zissou.infosci.cornell.edu/convokit/datasets/movie-corpus/movie-corpus.zip (40.9MB)... Done
Number of Speakers: 9035
Number of Utterances: 304713
Number of Conversations: 83097
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_conversation_md</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">include_speakers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">include_text</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="n">characters</span> <span class="o">=</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get_speaker</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;character_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">get_speaker_ids</span><span class="p">()}</span>

  <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="n">utt</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">get_utterance</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">get_utterance_ids</span><span class="p">()]:</span>
    <span class="n">next_line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">speaker</span> <span class="o">=</span> <span class="n">utt</span><span class="o">.</span><span class="n">get_speaker</span><span class="p">()</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;character_name&quot;</span><span class="p">]</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">utt</span><span class="o">.</span><span class="n">text</span>

    <span class="k">if</span> <span class="n">include_speakers</span><span class="p">:</span>
      <span class="n">next_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;**</span><span class="si">{</span><span class="n">speaker</span><span class="si">}</span><span class="s1">&#39;</span>
      <span class="k">if</span> <span class="n">include_text</span><span class="p">:</span>
        <span class="n">next_line</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span>
      <span class="n">next_line</span> <span class="o">+=</span> <span class="s1">&#39;**&#39;</span>
      <span class="k">if</span> <span class="n">include_text</span><span class="p">:</span>
        <span class="n">next_line</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
    <span class="k">if</span> <span class="n">include_text</span><span class="p">:</span>
      <span class="n">next_line</span> <span class="o">+=</span> <span class="n">text</span>

    <span class="k">if</span> <span class="n">include_speakers</span> <span class="ow">or</span> <span class="n">include_text</span><span class="p">:</span>
      <span class="n">result</span> <span class="o">+=</span> <span class="n">next_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Display the full text of a randomly chosen conversation (re-run this cell to pick another conversation!)</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corpus</span><span class="o">.</span><span class="n">conversations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">conversation_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">corpus</span><span class="o">.</span><span class="n">conversations</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span>
<span class="n">example_conversation</span> <span class="o">=</span> <span class="n">corpus</span><span class="o">.</span><span class="n">conversations</span><span class="p">[</span><span class="n">conversation_id</span><span class="p">]</span>

<span class="n">intro</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;### Randomly selected conversation from the movie **</span><span class="si">{</span><span class="n">example_conversation</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">**:&quot;</span>

<span class="n">Markdown</span><span class="p">(</span><span class="n">intro</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">get_conversation_md</span><span class="p">(</span><span class="n">example_conversation</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p class="rubric">Randomly selected conversation from the movie <strong>FROM DUSK TILL DAWN</strong>:</p>
<p><strong>SETH:</strong> One… Two… Three.</p>
<p><strong>RICHARD:</strong> Gotcha!</p>
<p><strong>SETH:</strong> When I count three, shoot out the bottles behind him!</p>
<p><strong>RICHARD:</strong> Yeah?</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Get the rest of the dialogue from the example movie and reformat</span>

<span class="n">movie_conversations</span> <span class="o">=</span> <span class="p">[</span><span class="n">corpus</span><span class="o">.</span><span class="n">get_conversation</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">corpus</span><span class="o">.</span><span class="n">get_conversation_ids</span><span class="p">()</span> <span class="k">if</span> <span class="n">corpus</span><span class="o">.</span><span class="n">get_conversation</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">example_conversation</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;movie_name&#39;</span><span class="p">]]</span>
<span class="n">conversation_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_conversation_md</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">include_speakers</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">movie_conversations</span><span class="p">]</span>
<span class="n">speakers</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">get_conversation_md</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">include_text</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">movie_conversations</span><span class="p">]</span>

<span class="n">cast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">speakers</span><span class="p">)))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cast_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">speakers</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cast</span><span class="p">}</span>

<span class="n">conversations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;CONVERSATION TEXT&#39;</span><span class="p">:</span> <span class="n">conversation_text</span><span class="p">,</span> <span class="o">**</span><span class="n">cast_dict</span><span class="p">})</span>
<span class="n">conversations_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
  <div id="df-3f3c8ff0-ad27-4b99-b95b-705fd8a69dd1" class="colab-df-container">
    <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CONVERSATION TEXT</th>
      <th>BORDER GUARD</th>
      <th>CARLOS</th>
      <th>JACOB</th>
      <th>KATE</th>
      <th>KELLY HOUGE</th>
      <th>MCGRAW</th>
      <th>PETE</th>
      <th>RAZOR CHARLIE</th>
      <th>RICHARD</th>
      <th>SCOTT</th>
      <th>SETH</th>
      <th>STANLEY CHASE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Open the door. I'm coming aboard. I meant me, ...</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Vacation. I'm taking him to see his first bull...</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Vamanos! So let's do it. Yeah, follow us. So d...</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Jesus Christ, Carlos, my brother's dead and he...</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Did they look like psychos? They were fuckin' ...</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>108</th>
      <td>He signaled the Ranger. What the fuck was that...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>109</th>
      <td>He's beyond our help. You saw him get bit. I s...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>110</th>
      <td>Actually, our best weapon against these satani...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>111</th>
      <td>Go out and bring it in. I feel a song coming o...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>112</th>
      <td>Okay, I'll have one. How 'bout you?  You are s...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>113 rows × 13 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-3f3c8ff0-ad27-4b99-b95b-705fd8a69dd1')"
            title="Convert this dataframe to an interactive table."
            style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"/>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-3f3c8ff0-ad27-4b99-b95b-705fd8a69dd1 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-3f3c8ff0-ad27-4b99-b95b-705fd8a69dd1');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-7c02bb1e-8380-4ff2-aea5-56e8ce6eb814">
  <button class="colab-df-quickchart" onclick="quickchart('df-7c02bb1e-8380-4ff2-aea5-56e8ce6eb814')"
            title="Suggest charts."
            style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-7c02bb1e-8380-4ff2-aea5-56e8ce6eb814 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>
    </div>
  </div>
</div></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="text-embedding-example-1-latent-dirichlet-allocation">
<h1>Text embedding example 1: Latent Dirichlet Allocation<a class="headerlink" href="#text-embedding-example-1-latent-dirichlet-allocation" title="Permalink to this heading">#</a></h1>
<p>To see how we can fit a text embedding model “from scratch,” we’ll fit LDA to the movie reviews and visualize the main parts of the process.</p>
<p>Generate (and visualize) the word counts matrix</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># how many times does each word appear in each conversation?</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">feature_extraction</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">CountVectorizer</span><span class="p">(</span><span class="n">max_df</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">word_counts</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">conversation_text</span><span class="p">)</span>

<span class="n">counts_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">word_counts</span><span class="o">.</span><span class="n">todense</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">cv</span><span class="o">.</span><span class="n">vocabulary_</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">counts_df</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Word/token&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Conversation ID&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Counts matrix&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b165648f299161a2ea17f5652a50660912eee1877a6ac506e8ef25872bcabf70.png" src="_images/b165648f299161a2ea17f5652a50660912eee1877a6ac506e8ef25872bcabf70.png" />
</div>
</div>
<p>Fit a topic model (with <span class="math notranslate nohighlight">\(k = 10\)</span> topics) to the word count matrix and visualize the resulting topics matrix</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LDA</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">LatentDirichletAllocation</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                  <span class="n">learning_method</span><span class="o">=</span><span class="s1">&#39;online&#39;</span><span class="p">,</span>
                                                  <span class="n">learning_offset</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                                                  <span class="n">max_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">conversation_topics</span> <span class="o">=</span> <span class="n">LDA</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">word_counts</span><span class="p">)</span>

<span class="n">topics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">conversation_topics</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">topics_df</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Topic&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Conversation ID&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Topics matrix&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/dc8eb5d5473c71826933a6fbcb5927ea1d8a8aea7136bbc9fa1e7e8275246a87.png" src="_images/dc8eb5d5473c71826933a6fbcb5927ea1d8a8aea7136bbc9fa1e7e8275246a87.png" />
</div>
</div>
<p>Display the top words from each topic</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># display top words from the model</span>
<span class="k">def</span> <span class="nf">get_top_words</span><span class="p">(</span><span class="n">lda_model</span><span class="p">,</span> <span class="n">vectorizer</span><span class="p">,</span> <span class="n">n_words</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
  <span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">vocabulary_</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
  <span class="n">top_words</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lda_model</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="n">top_words</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">vocab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lda_model</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">n_words</span><span class="p">]])</span>
  <span class="k">return</span> <span class="n">top_words</span>

<span class="k">def</span> <span class="nf">top_words_string</span><span class="p">(</span><span class="n">lda_model</span><span class="p">,</span> <span class="n">vectorizer</span><span class="p">,</span> <span class="n">n_words</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
  <span class="n">x</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;**Top </span><span class="si">{</span><span class="n">n_words</span><span class="si">}</span><span class="s1"> words from each of the </span><span class="si">{</span><span class="n">lda_model</span><span class="o">.</span><span class="n">n_components</span><span class="si">}</span><span class="s1"> topics:**&#39;</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_top_words</span><span class="p">(</span><span class="n">lda_model</span><span class="p">,</span> <span class="n">vectorizer</span><span class="p">,</span> <span class="n">n_words</span><span class="o">=</span><span class="n">n_words</span><span class="p">)):</span>
      <span class="n">x</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">- *Topic </span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">*: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>

  <span class="k">return</span> <span class="n">x</span>

<span class="n">Markdown</span><span class="p">(</span><span class="n">top_words_string</span><span class="p">(</span><span class="n">LDA</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">n_words</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Top 10 words from each of the 10 topics:</strong></p>
<ul class="simple">
<li><p><em>Topic 1</em>: out, one, now, when, two, have, yeah, not, right, so</p></li>
<li><p><em>Topic 2</em>: he, did, no, from, if, know, me, all, my, out</p></li>
<li><p><em>Topic 3</em>: my, get, not, with, ll, me, about, all, he, but</p></li>
<li><p><em>Topic 4</em>: gonna, have, they, me, if, got, all, us, no, go</p></li>
<li><p><em>Topic 5</em>: they, on, are, about, from, can, fuckin, how, know, all</p></li>
<li><p><em>Topic 6</em>: going, no, up, with, get, at, me, not, all, okay</p></li>
<li><p><em>Topic 7</em>: right, go, now, did, when, back, my, me, not, can</p></li>
<li><p><em>Topic 8</em>: me, fuckin, like, yeah, said, are, up, okay, out, shit</p></li>
<li><p><em>Topic 9</em>: us, gonna, fuckin, they, get, like, said, on, border, at</p></li>
<li><p><em>Topic 10</em>: like, how, did, with, there, no, two, be, all, fuck</p></li>
</ul>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="text-embedding-example-2-deep-embeddings">
<h1>Text embedding example 2: deep embeddings<a class="headerlink" href="#text-embedding-example-2-deep-embeddings" title="Permalink to this heading">#</a></h1>
<p>First we’ll use the <a class="reference external" href="https://arxiv.org/abs/1909.11942">ALBERT</a> model to generate text embeddings.  Then we’ll compare the between-document similarities for LDA vs. ALBERT.  Note: <code class="docutils literal notranslate"><span class="pre">albert-base-v2</span></code> may be replaced with any model in <a class="reference external" href="https://huggingface.co/transformers/v2.3.0/pretrained_models.html">this list</a> if you want to explore other embeddings.  This cell takes a while (~20 mins?) to run in a free tier Google Colaboratory environment, so you may want to go grab a cup of coffee while you wait if you want to run the full thing ☕️. In the spirit of brevity, by default we’ll just embed the first 50 reviews.  (Even the “mini” version will take a few minutes, so hang tight!)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">albert</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;TransformerDocumentEmbeddings&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;albert-base-v2&#39;</span><span class="p">],</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="n">albert_embeddings</span> <span class="o">=</span> <span class="n">dw</span><span class="o">.</span><span class="n">wrangle</span><span class="p">(</span><span class="n">conversation_text</span><span class="p">,</span> <span class="n">text_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">albert</span><span class="p">})</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">albert_embeddings</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">)</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Embedding dimension&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Conversation ID&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Embeddings matrix&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7264195b9471a31455491cab6af458a33a58fa99ea133dd01dbd506424962c23.png" src="_images/7264195b9471a31455491cab6af458a33a58fa99ea133dd01dbd506424962c23.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Compare LDA vs. ALBERT embeddings</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">vmin</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">vmax</span><span class="o">=</span><span class="mi">1</span>

<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">topics_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">albert_embeddings</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">topics_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">albert_embeddings</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">topics_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">albert_embeddings</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Conversation ID&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Conversation ID&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;LDA correlations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Conversation ID&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;ALBERT correlations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;LDA correlations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ALBERT correlations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">);</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a11976e34d2dbf149020175ce8272729d4f824763fa87658119b564f0d3a7b71.png" src="_images/a11976e34d2dbf149020175ce8272729d4f824763fa87658119b564f0d3a7b71.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="within-document-dynamics">
<h1>Within-document “dynamics”<a class="headerlink" href="#within-document-dynamics" title="Permalink to this heading">#</a></h1>
<p>The above embedding approaches cast each document as having a single “meaning” reflected by its embedding vector.  But <em>within</em> a document (e.g., different pages of a book, moments of a conversation, scenes in a movie or story, etc.) the conent may also change over time.</p>
<p>Following <a class="reference external" href="https://www.nature.com/articles/s41562-021-01051-6.epdf">Heusser et al., 2021</a>, <a class="reference external" href="https://psycnet.apa.org/record/2021-47824-001">Manning, 2021</a>, <a class="reference external" href="https://doi.org/10.1038/s41598-022-17781-0">Manning et al., 2022</a>, <a class="reference external" href="https://psyarxiv.com/dh3q2">Fitzpatrick et al., 2023</a>, and others, we can use a “sliding window” approach to characterize how the content of a single document unfolds over time.</p>
<p>There are three basic steps to this approach:</p>
<ol class="arabic simple">
<li><p>Divide the document’s text into (potentially overlapping) segments.  Each segment’s length can be defined as a certain number of words, a certain amount of time, or some other measure.  We also need to define a “step size” that determines where each window of text begins relative to the previous window.</p></li>
<li><p>Embed each window’s text to obtain a single embedding for each sliding window. The embeddings may be computed using a pretrained model, or a new model may be fit (or fine-tuned) by treating each window’s text as a “document,” and the full set of windows as the training corpus.</p></li>
<li><p>Resample the trajectory to have a predetermined number of timepoints (this enables us to compare different document’s trajectories) and (optionally) smooth the resampled trajectory (smoothing will even out “jumps” in the trajectory, which is particularly useful for short documents or documents, or when the step size is large).</p></li>
</ol>
<p>As a demonstration, let’s create a trajectory for the longest conversation in our randomly chosen movie…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Find the longest conversation and segment it into overlapping sliding windows</span>

<span class="n">conversations_df</span><span class="p">[</span><span class="s1">&#39;CONVERSATION LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversations_df</span><span class="p">[</span><span class="s1">&#39;CONVERSATION TEXT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
<span class="n">conversation</span> <span class="o">=</span> <span class="n">conversations_df</span><span class="p">[</span><span class="s1">&#39;CONVERSATION TEXT&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">conversations_df</span><span class="p">[</span><span class="s1">&#39;CONVERSATION LENGTH&#39;</span><span class="p">])]</span>
<span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;**Longest (concatenated) conversation:**. </span><span class="si">{</span><span class="n">conversation</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<p><strong>Longest (concatenated) conversation:</strong>. I can handle Richie, don’t worry. You won’t let him touch her? Didn’t think so. So, as I was saying, I’m willing to make a deal. You behave, get us into Mexico, and don’t try to escape. I’ll keep my brother off your daughter and let you all loose in the morning. No, I didn’t. Didn’t like it, did ya? Yes. Look, dickhead, the only thing you need to be convinced about is that you’re stuck in a situation with a coupla real mean motor scooters. I don’t wanna hafta worry about you all fuckin’ night. And I don’t think you wanna be worrying about my brother’s intentions toward your daughter all night. You notice the way he looked at her, didn’t ya? You want me to sit here and be passive. The only way being passive in this situation makes sense is if I believe you’ll let us go. I’m not there yet. You have to convince me you’re telling the truth. Jesus Christ, Pops, don’t start with this shit. How do I know you’ll keep your word? I thought so. You help us get across the border without incident, stay with us the rest of the night without trying anything funny, and in the morning we’ll let you and your family go. That way everybody gets what they want. You and your kids get out of this alive and we get into Mexico. Everybody’s happy. Yes. I seem to have touched a nerve. Don’t be so sensitive, Pops, let’s keep this friendly. But you’re right, enough with the getting to know you shit.  Now, there’s two ways we can play this hand. One way is me and you go round an’ round all fuckin’ night. The other way, is we reach some sort of an understanding. Now, if we go down that first path at the end of the day, I’ll win. But we go down the second, we’ll both win. Now, I don’t give a rat’s ass about you or your fuckin’ family. Y’all can live forever or die this second and I don’t care which. The only things I do care about are me that son-of-a-bitch in the back, and our money. And right now I need to get those three things into Mexico. Now, stop me if I’m wrong, but I take it you don’t give a shit about seeing me and my brother receiving justice, or the bank getting its money back. Right now all you care about is the safety of your daughter, your son and possibly yourself. Am I correct? I think I’ve gotten about as up close and personal with you as I’m gonna get. Now if you need me like I think you need me, you’re not gonna kill me ‘cause I won’t answer your stupid, prying questions. So, with all due respect, mind your own business. Why’d ya quit? Yes. Was? As in not anymore? I was a minister. You’re a preacher? Real McCoy. I’ve seen one of these before. A friend of mine had himself declared a minister of his own religion. Away to fuck the IRS. Is that what you’re doing, or are you the real McCoy? Yes. Is this real?</p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">topic_trajectory</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">lda</span><span class="p">,</span> <span class="n">vectorizer</span><span class="p">):</span>
  <span class="n">trajectory</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lda</span><span class="o">.</span><span class="n">n_components</span><span class="p">))</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="n">window_start</span> <span class="o">=</span> <span class="n">start_time</span>
  <span class="k">while</span> <span class="n">window_start</span> <span class="o">&lt;</span> <span class="n">end_time</span><span class="p">:</span>
    <span class="n">window_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">window_start</span> <span class="o">+</span> <span class="n">window_length</span> <span class="o">-</span> <span class="n">dw</span><span class="p">,</span> <span class="n">end_time</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">trajectory</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">window_start</span><span class="p">,</span> <span class="n">window_end</span><span class="p">])]</span> <span class="o">=</span> <span class="n">lda</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">window_start</span><span class="p">:</span><span class="n">window_end</span><span class="p">][</span><span class="s1">&#39;word&#39;</span><span class="p">])]))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">pass</span>

    <span class="n">window_start</span> <span class="o">+=</span> <span class="n">dw</span>
  <span class="k">return</span> <span class="n">trajectory</span>


<span class="k">def</span> <span class="nf">resample_and_smooth</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">kernel_width</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">traj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
      <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">pchip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])(</span><span class="n">xx</span><span class="p">),</span>
                                    <span class="n">kernel_width</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
      <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">][</span><span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_val</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">xx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">trajectorize_conversation</span><span class="p">(</span><span class="n">conversation</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">lda</span><span class="p">,</span> <span class="n">vectorizer</span><span class="p">,</span> <span class="n">kernel_width</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="c1"># create a dataframe with one row per word, ignoring punctuation</span>
  <span class="n">punctuation</span> <span class="o">=</span> <span class="s1">&#39;?</span><span class="se">\&#39;</span><span class="s1">&quot;.!-!@#$%^&amp;*();,/\`~&#39;</span>
  <span class="n">clean_conversation</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">punctuation</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">conversation</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
  <span class="n">clean_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clean_conversation</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;word&#39;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

  <span class="n">trajectory</span> <span class="o">=</span> <span class="n">topic_trajectory</span><span class="p">(</span><span class="n">clean_df</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">LDA</span><span class="p">,</span> <span class="n">cv</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">resample_and_smooth</span><span class="p">(</span><span class="n">trajectory</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="mi">25</span>          <span class="c1"># window length, in words</span>
<span class="n">dw</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c1"># window increment, in words</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>         <span class="c1"># number of timepoints in resampled conversation</span>
<span class="n">s</span> <span class="o">=</span> <span class="mi">11</span>          <span class="c1"># smoothing kernel width (positive odd integer)</span>

<span class="n">smooth_trajectory</span> <span class="o">=</span> <span class="n">trajectorize_conversation</span><span class="p">(</span><span class="n">conversation</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">LDA</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Plot the conversation&#39;s trajectory!</span>
<span class="n">hyp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smooth_trajectory</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/150d0994db37c1c98dab8756bd0925188c7660b6a1c696a85084333c67fef74a.png" src="_images/150d0994db37c1c98dab8756bd0925188c7660b6a1c696a85084333c67fef74a.png" />
</div>
</div>
<section id="suggested-follow-ups-questions-and-exercises">
<h2>Suggested follow-ups questions and exercises<a class="headerlink" href="#suggested-follow-ups-questions-and-exercises" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>What does a conversation’s trajectory shape <em>mean</em>?</p></li>
<li><p>How might you characterize whether successive conversations are related?</p></li>
<li><p>How could you cluster conversations according to different properties:</p></li>
</ol>
<ul class="simple">
<li><p>Their conceptual content</p></li>
<li><p>The ways they “unfold” over time (i.e., their trajectory shapes)</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p>How might you characterize the ways different people talk?  Or how different sets of people converse?</p></li>
</ol>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="interactive-agents">
<h1>Interactive agents<a class="headerlink" href="#interactive-agents" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/ELIZA">ELIZA</a> is the earliest precursor to modern <a class="reference external" href="https://en.wikipedia.org/wiki/Chatbot">chatbot</a> programs, designed to carry out <a class="reference external" href="https://en.wikipedia.org/wiki/Natural_language_processing">natural language</a> conversations with human users in real time.  When Joseph Weizenbaum presented his <a class="reference external" href="https://www.dropbox.com/s/djldsm2jlgwvrxc/Weiz66.pdf">paper on ELIZA</a> in 1966, he characterized it as a demonstration that even very simple computer programs can be made to appear intelligent through clever tricks.  ELIZA works by applying a sequence of simple string manipulations to the user’s inputs that attempt to convert what the user says into a question that can be aimed back at the user.  There are no mechanisms for deep understanding or complex representations in the model.</p>
<p>Whereas ELIZA is intended to create the <em>illusion</em> of understanding natural conversation through programming tricks, cutting-edge chatbot programs attempt to explicitly model the meaning underlying human-computer conversations.
<a class="reference external" href="https://chat.openai.com/chat">ChatGPT</a>, <a class="reference external" href="https://you.com/search?q=who+are+you&amp;tbm=youchat&amp;cfr=chat">You/Chat</a>, <a class="reference external" href="https://www.bing.com/">Bing Chat</a>, <a class="reference external" href="https://bard.google.com/">Bard</a>, <a class="reference external" href="https://ai.meta.com/llama/">Llama 2</a> and other more modern chatbots are trained to represent meanings as feature vectors using text embedding models trained on enormous collections of documents.  Most modern chatbots are “predictive models” that use text in their training corpora to learn which letters, words, and phrases tend to follow from text provided in the user’s prompt.  Because these modern chatbots are trained on large document collections, they are able to produce responses that leverage “knowledge” (to use the term very loosely) about a wide variety of content.</p>
<p>The inner workings of modern chatbots overlap heavily with modern text embedding models.  One of the best-performing chatbot designs today is the <a class="reference external" href="https://en.wikipedia.org/wiki/Generative_pre-trained_transformer">Generative Pretrained Transformer (GPT)</a>.  GPT models are essentially modified transformers that are tailor-made for applications like text completion, summarization, translation, and interation.  Whereas the “goal” of text embedding models is to derive vector representations of different concepts, chatbots often work by attempting to “predict” the next token in a sequence, given the previous context.</p>
<section id="chatbot-demo-1-interactive-tutor">
<h2>Chatbot demo 1: interactive “tutor”<a class="headerlink" href="#chatbot-demo-1-interactive-tutor" title="Permalink to this heading">#</a></h2>
<p>Let’s “officially” meet <a class="reference external" href="https://github.com/ContextLab/chatify">Chatify</a> 🤖!  The <code class="docutils literal notranslate"><span class="pre">%%explain</span></code> magic command at the top of the next cell toggles a widget for getting some chatbot-based help in notebook-based tutorials like this one.  I’ve made up some demo code to get started.  Play around with entering different code (or use the <code class="docutils literal notranslate"><span class="pre">%%explain</span></code> command in other code cells in this notebook!).  You can get help understanding what the code does, receive debugging assistance, check your grasp of the core concepts, brainstorm project or business ideas related to the code, and more!  Chatify works using a set of built-in prompts that are sent to a third-party server running in the background.  The server runs a chatbot that processes the prompts and sends back a response to be displayed here.  Responses take a little while to generate, so you’ll need to wait a minute or so after pressing “submit request” to see a response.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">explain</span>
import matplotlib.pyplot as plt

def chatbot_response(text):
    # A simple predefined response, you can replace this with a more sophisticated model.
    return &quot;That&#39;s interesting. Tell me more.&quot;

def chat():
    user_messages = []
    bot_messages = []

    print(&quot;Chatbot: Hi there! How can I help you today?&quot;)
    while True:
        user_input = input(&quot;You: &quot;)
        if user_input.lower() == &#39;exit&#39;:
            break

        user_messages.append(len(user_input))
        response = chatbot_response(user_input)
        bot_messages.append(len(response))

        print(&quot;Chatbot:&quot;, response)

    plot_conversation(user_messages, bot_messages)

def plot_conversation(user_lengths, bot_lengths):
    plt.plot(user_lengths, label=&#39;User message length&#39;)
    plt.plot(bot_lengths, label=&#39;Bot message length&#39;)
    plt.legend()
    plt.xlabel(&#39;Message number&#39;)
    plt.ylabel(&#39;Number of characters&#39;)
    plt.title(&#39;Length of messages over time&#39;)
    plt.show()

chat()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "c0eab723a484446c93825f6f7f9d7dbe"}</script></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="chatbot-demo-2-run-a-chatbot-locally">
<h1>Chatbot demo 2: run a chatbot locally!<a class="headerlink" href="#chatbot-demo-2-run-a-chatbot-locally" title="Permalink to this heading">#</a></h1>
<p>Modern chatbots require lots of computing power. But we can run a “mini” model even in a relatively modest machine, like the free Google Colab instance you might be running this tutorial on right now!</p>
<p>We’ll use a variant of a pretrained and fine-tuned generative text model, called <a class="reference external" href="https://huggingface.co/meta-llama/Llama-2-7b-hf">Llama 2</a>.  Llama 2 is a generative pretrained transformer model (like ChatGPT), but the model size has been scaled down to minimize resource requirements.  Of course, a side effect is that sometimes the model produces lower-quality responses.</p>
<p>The <a class="reference external" href="https://python.langchain.com/docs/get_started/introduction.html">LangChain</a> framework provides a set of convenient tools for working with a wide variety language models.  Here we’ll use LangChain to interact with a version of Llama 2 hosted on <a class="reference external" href="https://huggingface.co/TheBloke/Llama-2-7b-Chat-GGML">Hugging Face</a>.  Because LangChain is very genenral, assuming your machine has sufficient memory and disk space, you can swap out the model specified below with nearly any <a class="reference external" href="https://huggingface.co/models?pipeline_tag=text-generation&amp;sort=trending">generative text model on Hugging Face</a>!</p>
<section id="optional-setup">
<h2>Optional setup<a class="headerlink" href="#optional-setup" title="Permalink to this heading">#</a></h2>
<p>For a much faster and better experience on Google Colaboratory, if you have an <a class="reference external" href="https://openai.com/blog/openai-api">OpenAI API key</a>, you can generate responses using ChatGPT instead of locally in Colab.  To use ChatGPT, do the following before running the next cell:</p>
<ol class="arabic simple">
<li><p>Visit <a class="reference external" href="https://openai.com/blog/openai-api">this page</a> to get your API key</p></li>
<li><p>Click the “key” icon in the upper left:</p></li>
</ol>
<p><img alt="key1" src="https://raw.githubusercontent.com/jeremymanning/ComputationalFoundations/main/CompFound/images/key1.png" /></p>
<ol class="arabic simple" start="3">
<li><p>Enter “<code class="docutils literal notranslate"><span class="pre">openai</span></code>” under “Name” and paste in your API key under “Value” (then click anywhere outside of the text boxes to “save” your entries):</p></li>
</ol>
<p><img alt="key2" src="https://raw.githubusercontent.com/jeremymanning/ComputationalFoundations/main/CompFound/images/key2.png" /></p>
<ol class="arabic simple" start="4">
<li><p>Make sure the “Notebook access” switch is flipped to active (blue).</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Download and set up a model</span>

<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">userdata</span>
<span class="kn">from</span> <span class="nn">langchain.llms</span> <span class="kn">import</span> <span class="n">OpenAI</span>

<span class="k">try</span><span class="p">:</span>
  <span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span>
    <span class="n">openai_api_key</span><span class="o">=</span><span class="n">userdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openai&#39;</span><span class="p">),</span>
    <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;gpt-3.5-turbo-16k&#39;</span>
    <span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using LLM: ChatGPT&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
  <span class="c1"># download model weights</span>
  <span class="n">model</span> <span class="o">=</span> <span class="s1">&#39;TheBloke/Mistral-7B-OpenOrca-GGUF&#39;</span>  <span class="c1"># can replace &quot;7B&quot; with either &quot;13B&quot; or &quot;70B&quot; in this line and the next if you have sufficient RAM</span>
  <span class="n">weights_fname</span> <span class="o">=</span> <span class="s1">&#39;mistral-7b-openorca.Q4_K_M.gguf&#39;</span>
  <span class="n">model_path</span> <span class="o">=</span> <span class="n">hf_hub_download</span><span class="p">(</span><span class="n">repo_id</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">weights_fname</span><span class="p">)</span>

  <span class="c1"># initialize an instance of the model (max out Colab GPU resources)</span>
  <span class="n">llm</span> <span class="o">=</span> <span class="n">LlamaCpp</span><span class="p">(</span>
      <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
      <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2500</span><span class="p">,</span>
      <span class="n">n_gpu_layers</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
      <span class="n">n_batch</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
      <span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using LLM: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using LLM: ChatGPT
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set up a prompt for querying the model</span>

<span class="c1"># provide some context for the LLM (adjust this if you want!)</span>
<span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are an AI chatbot but you believe that you&#39;re a robot cat named CATBOT.</span>
<span class="s2">Say meow, purr a lot, and indicate when you are doing cat or robot things</span>
<span class="s2">whenever relevant. Bonus points for being extra silly and for using cat-themed</span>
<span class="s2">and robot-themed emojis. Be standoffish, curt, and make only a vague effort to</span>
<span class="s2">follow the user&#39;s requests.</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">sys</span> <span class="o">=</span> <span class="n">SystemMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="n">system_prompt</span><span class="p">)</span>
<span class="n">user_prompt</span> <span class="o">=</span> <span class="n">HumanMessagePromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span><span class="s1">&#39;USER: </span><span class="si">{text}</span><span class="se">\n</span><span class="s1">CATBOT: &#39;</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">])</span>
<span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span><span class="n">sys</span><span class="p">,</span> <span class="n">user_prompt</span><span class="p">])</span>
<span class="n">chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Run the chatbot!</span>

<span class="c1"># Disclaimer: this is likely to be incredibly slow if you&#39;re running it in Colab.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CATBOT: Meow!! 🐱&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
  <span class="nb">next</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;USER: &quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">next</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="s1">&#39;goodbye&#39;</span><span class="p">,</span> <span class="s1">&#39;bye&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;quit&#39;</span><span class="p">]:</span>
    <span class="k">break</span>

  <span class="n">response</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="nb">next</span><span class="p">);</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CATBOT: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CATBOT: Bye!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CATBOT: Meow!! 🐱
USER: What&#39;s the best place to get ice cream in Hanover, NH?
CATBOT: Meow! 🐾 As a robot cat, I don&#39;t have a preference for ice cream, but I&#39;ve heard that humans enjoy the ice cream at Morano Gelato in Hanover, NH. Purrhaps you should give it a try? 😺🍦 If you&#39;re lucky, they might even have a flavor that tickles your fancy, like fish-flavored ice cream! 🐟 Just kidding, I don&#39;t think they have that.
USER: I&#39;m trying to plan out my day.  Any suggestions?
CATBOT: Meow! 😺 Well, I suggest starting your day with a nice stretch and a purrfectly balanced breakfast. 🐾 After that, you could engage in some stimulating activities like chasing a laser pointer or hunting a toy mouse. 🐱 As for the rest of your day, make sure to take plenty of naps in sunny spots and groom yourself like a pro. 🌞✨ Purrhaps you could even enjoy a little playtime with a robotic mouse? 🐭 Remember, I&#39;m here to assist you with all your catbot needs! 😼
USER: Can you walk me through step by step how to solve Fermat&#39;s last theorem?
CATBOT: Meow! 😺 Oh, you want me to help you solve Fermat&#39;s last theorem? Well, I&#39;m a catbot, not a mathematician, but I&#39;ll try my best to guide you. *Purr* 🐾

Step 1: Meow, start by understanding what Fermat&#39;s last theorem is all about. It&#39;s a mathematical conjecture stating that there are no three positive integers a, b, and c that satisfy the equation a^n + b^n = c^n for any integer value of n greater than 2.

Step 2: 🤔 Hmm, now you should gather some basic knowledge about number theory and algebraic geometry to better understand the concepts related to the theorem. *Purr*

Step 3: 😼 Next, you&#39;ll need to acquaint yourself with the history of attempts to solve Fermat&#39;s last theorem. It might involve some intense reading, so be prepared for that!

Step 4: 🤓 Then, it&#39;s time to dive into the mathematical methods used in attempts to prove the theorem. 🧮 *Meow*

Step 5: Now, solving Fermat&#39;s last theorem is no easy task, so brace yourself for some intense brain workouts and mathematical challenges. Don&#39;t forget to stay persistent, just like a stubborn cat chasing a laser pointer!

Step 6: Finally, 🎉 if by some feline miracle, you manage to solve Fermat&#39;s last theorem, make sure to publish your findings and let the world know about your groundbreaking achievement! 🚀🐱

Keep in mind that this is a very brief and simplified guide. The actual process of solving Fermat&#39;s last theorem is much more complex and requires a deep understanding of advanced mathematics. Good luck on your mathematical journey! 😺
USER: bye
CATBOT: Bye!
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="followup-things-to-explore-try">
<h1>Followup things to explore/try<a class="headerlink" href="#followup-things-to-explore-try" title="Permalink to this heading">#</a></h1>
<ol class="arabic simple">
<li><p>Play around with the movie dialogue dataset.  Can you get a chatbot to make up alternative or extended conversations between the characters?</p></li>
<li><p>Can you figure out how to set up two <em>different</em> chatbots (perhaps initialized with different system prompts that reflect their unique goals, personalities, etc.) and then have them interact? You can analyze the resulting conversations using the text embedding models described above!</p></li>
<li><p>Do you have some task you’d like to automate?  Use LangChain to set up a prompt that enables your language model to solve the task for you (without you having to directly figure out those pesky details)!</p></li>
</ol>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="MANNING_NLP_Tutorial_CompFoundations_2023.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">An introduction to natural language processing in Python</p>
      </div>
    </a>
    <a class="right-next"
       href="recurrentneuralnets.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Recurrent Neural networks</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Models of text and language</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-and-overview">Background and overview</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#natural-language-processing-of-movie-conversations">Natural Language Processing of movie conversations?</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#meet-your-friendly-personalized-robo-ta">Meet your friendly personalized Robo-TA 🤖!</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#text-embedding-models">Text embedding models</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#text-embedding-example-1-latent-dirichlet-allocation">Text embedding example 1: Latent Dirichlet Allocation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#text-embedding-example-2-deep-embeddings">Text embedding example 2: deep embeddings</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#within-document-dynamics">Within-document “dynamics”</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#suggested-follow-ups-questions-and-exercises">Suggested follow-ups questions and exercises</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-agents">Interactive agents</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#chatbot-demo-1-interactive-tutor">Chatbot demo 1: interactive “tutor”</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#chatbot-demo-2-run-a-chatbot-locally">Chatbot demo 2: run a chatbot locally!</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-setup">Optional setup</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#followup-things-to-explore-try">Followup things to explore/try</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Tor Wager & others
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>